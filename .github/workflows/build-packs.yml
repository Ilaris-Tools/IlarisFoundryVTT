name: ðŸ”¨ Build DB for Ilaris in Foundry VTT

on:
    workflow_call:
        inputs:
            pre_release:
                description: Should be pre-release with hash
                type: boolean
                required: false
                default: true
    workflow_dispatch:
        inputs:
            pre_release:
                description: Should be pre-release with hash
                type: boolean
                required: false
                default: true

permissions:
    contents: write

jobs:
    pack:
        name: ðŸ“¦ Package application
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5
            - uses: actions/setup-node@v6
              with:
                  node-version: 22
            - name: ðŸš€ Install Dependencies
              run: |
                  npm install
            - name: ðŸ“¦ Package database files
              run: |
                  node utils/pack-all.js
                  # Show folder structure in comp_packs
                  ls -al comp_packs
                  ls -al comp_packs/beispiel-helden
            - name: ðŸ“– Read system.json
              id: read-system-json
              run: echo "SYSTEM_JSON=$(jq -c . < system.json)" >> $GITHUB_OUTPUT
            - name: âœï¸ Define variables for reusage
              id: variables
              run: |
                  # Read out information from system.json
                  system="${{fromJson(steps.read-system-json.outputs.SYSTEM_JSON).id}}"
                  echo "SYSTEM_NAME=${system}" >> $GITHUB_OUTPUT
                  echo "SYSTEM_NAME=${system}"
                  vers="${{fromJson(steps.read-system-json.outputs.SYSTEM_JSON).version}}"
                  echo "VERSION=${vers}"

                  # define release tag
                  if [ ${{ inputs.pre_release }} = false ]; then
                    tag="${vers}"
                  else
                    tag="${vers}-${{ github.sha }}"
                  fi
                  echo "TAG_NAME=${tag}" >> $GITHUB_OUTPUT
                  echo "TAG_NAME=${tag}"

                  # define filename
                  file="${system}.zip"
                  echo "FILENAME=${file}" >> $GITHUB_OUTPUT
                  echo "FILENAME=${file}"
            - name: ðŸ§ Adjust system.json, manifest and download link
              run: |
                manifest="${{fromJson(steps.read-system-json.outputs.SYSTEM_JSON).manifest}}"
                echo "Previous manifest: ${manifest}"
                manifest_release_path="https://github.com/${{ github.repository }}/releases/download/${{ steps.variables.outputs.TAG_NAME }}/system.json"
                download="${{fromJson(steps.read-system-json.outputs.SYSTEM_JSON).download}}"
                echo "Previous download: ${download}"
                download_release_path="https://github.com/${{ github.repository }}/releases/download/${{ steps.variables.outputs.TAG_NAME }}/${{ steps.variables.outputs.FILENAME }}"
                jq --arg manifest "$manifest_release_path" --arg download "$download_release_path" \
                  '.manifest = $manifest | .download = $download' system.json > tmp && mv tmp system.json
                echo "Overwrote system.json"
                echo "Adjusted manifest: $(jq .manifest system.json)"
                echo "Adjusted download: $(jq .download system.json)"
            - name: ðŸ“‚ Prepare app folder
              run: |
                  # Moving all files for system integration in here
                  mkdir "${{ steps.variables.outputs.SYSTEM_NAME }}"
                  mv -t "${{ steps.variables.outputs.SYSTEM_NAME }}" assets comp_packs css docs scripts styles templates utils
                  mv babel.config.cjs jsconfig.json LICENSE package.json package-lock.json README.md svgo.config.js system.json template.json update-creature-items.js -t "${{ steps.variables.outputs.SYSTEM_NAME }}"
            - name: ðŸ“¦ Zip application
              run: |
                  echo "Creating ${{ steps.variables.outputs.FILENAME }} from workspace"
                  sudo apt-get update -y
                  sudo apt-get install -y zip
                  zip -r "${{ steps.variables.outputs.FILENAME }}" ./${{ steps.variables.outputs.SYSTEM_NAME }}
            - name: Bump version and push tag
              uses: laputansoft/github-tag-action@v4.6
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  tag: "${{ steps.variables.outputs.TAG_NAME }}"
            - name: ðŸŽ‰ Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: "${{ steps.variables.outputs.TAG_NAME }}"
                  prerelease: "${{ inputs.pre_release || true }}"
                  files: |
                      CHANGELOG.md
                      ${{ steps.variables.outputs.SYSTEM_NAME }}/system.json
                      ${{ steps.variables.outputs.FILENAME }}