name: 🎲 Deploy Ilaris to Foundry VTT

on:
    push:
        branches: [main, master, develop]
    pull_request:
        branches: [develop]
        types: [opened, synchronize, reopened]
    workflow_dispatch:

env:
    SYSTEM_NAME: 'Ilaris'
    SYSTEM_PATH: '/home/leo/docker/foundryvtt-internal/foundry/data/Data/systems/Ilaris'

jobs:
    validate:
        name: 🔍 Validate System Files
        runs-on: ubuntu-latest

        outputs:
            system-version: ${{ steps.system-info.outputs.version }}
            system-title: ${{ steps.system-info.outputs.title }}

        steps:
            - name: 📥 Checkout Repository
              uses: actions/checkout@v4

            - name: 🔍 Validate system.json
              id: system-info
              run: |
                  echo "🔍 Validating system.json..."

                  if [ ! -f "system.json" ]; then
                    echo "❌ system.json not found"
                    exit 1
                  fi

                  # JSON Syntax prüfen
                  if ! jq empty system.json; then
                    echo "❌ system.json is not valid JSON"
                    jq . system.json || true
                    exit 1
                  fi

                  # Required fields prüfen
                  REQUIRED_FIELDS=("id" "title" "version" "compatibility")
                  for field in "${REQUIRED_FIELDS[@]}"; do
                    if ! jq -e ".$field" system.json > /dev/null; then
                      echo "❌ system.json missing required field: $field"
                      exit 1
                    fi
                  done

                  # System info extrahieren
                  SYSTEM_ID=$(jq -r '.id' system.json)
                  SYSTEM_TITLE=$(jq -r '.title' system.json)
                  SYSTEM_VERSION=$(jq -r '.version' system.json)
                  MIN_FOUNDRY=$(jq -r '.compatibility.minimum' system.json)
                  VERIFIED_FOUNDRY=$(jq -r '.compatibility.verified' system.json)

                  echo "✅ system.json is valid"
                  echo "📋 System ID: $SYSTEM_ID"
                  echo "📋 System Title: $SYSTEM_TITLE"
                  echo "📋 System Version: $SYSTEM_VERSION"
                  echo "📋 Foundry Compatibility: $MIN_FOUNDRY - $VERIFIED_FOUNDRY"

                  # Outputs für andere Jobs setzen
                  echo "version=$SYSTEM_VERSION" >> $GITHUB_OUTPUT
                  echo "title=$SYSTEM_TITLE" >> $GITHUB_OUTPUT

                  # Prüfen ob System ID korrekt ist
                  if [ "$SYSTEM_ID" != "ilaris" ]; then
                    echo "⚠️ Warning: System ID is '$SYSTEM_ID', expected 'ilaris'"
                  fi

            - name: 🔍 Validate template.json
              run: |
                  if [ -f "template.json" ]; then
                    echo "🔍 Validating template.json..."
                    if ! jq empty template.json; then
                      echo "❌ template.json is not valid JSON"
                      jq . template.json || true
                      exit 1
                    fi
                    echo "✅ template.json is valid"
                    
                    # Template structure prüfen
                    if jq -e '.Actor' template.json > /dev/null; then
                      ACTOR_TYPES=$(jq -r '.Actor.types[]?' template.json | tr '\n' ', ' | sed 's/,$//')
                      echo "📋 Actor Types: $ACTOR_TYPES"
                    fi
                    
                    if jq -e '.Item' template.json > /dev/null; then
                      ITEM_TYPES=$(jq -r '.Item.types[]?' template.json | tr '\n' ', ' | sed 's/,$//')
                      echo "📋 Item Types: $ITEM_TYPES"
                    fi
                  else
                    echo "ℹ️ template.json not found (optional)"
                  fi

            - name: 🔍 Analyze System Structure
              run: |
                  echo "🔍 Analyzing system structure..."

                  # JavaScript Dateien
                  JS_FILES=$(find . -name "*.js" -type f ! -path "./.git/*" ! -path "./node_modules/*" | wc -l)
                  echo "📜 JavaScript files: $JS_FILES"
                  if [ $JS_FILES -gt 0 ]; then
                    echo "   Main files:"
                    find . -name "*.js" -type f ! -path "./.git/*" ! -path "./node_modules/*" | head -5 | sed 's/^/   - /'
                    if [ $JS_FILES -gt 5 ]; then
                      echo "   ... and $((JS_FILES - 5)) more"
                    fi
                  fi

                  # CSS Dateien
                  CSS_FILES=$(find . -name "*.css" -type f ! -path "./.git/*" | wc -l)
                  echo "🎨 CSS files: $CSS_FILES"
                  if [ $CSS_FILES -gt 0 ]; then
                    find . -name "*.css" -type f ! -path "./.git/*" | sed 's/^/   - /'
                  fi

                  # Handlebars Templates
                  HBS_FILES=$(find . -name "*.hbs" -type f ! -path "./.git/*" | wc -l)
                  echo "📋 Handlebars templates: $HBS_FILES"

                  # Language files
                  LANG_FILES=$(find . -name "*.json" -path "*/lang/*" -type f | wc -l)
                  echo "🌍 Language files: $LANG_FILES"
                  if [ $LANG_FILES -gt 0 ]; then
                    find . -name "*.json" -path "*/lang/*" -type f | sed 's/^/   - /'
                  fi

                  # Größe berechnen
                  TOTAL_SIZE=$(du -sh . | cut -f1)
                  echo "📏 Total system size: $TOTAL_SIZE"

    deploy:
        name: 🚀 Deploy to Foundry Server
        runs-on: ubuntu-latest
        needs: validate
        # Deploy bei: Push auf main/master/develop ODER manual workflow_dispatch ODER manual rerun
        if: ${{ (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')) || github.event_name == 'workflow_dispatch' || github.run_attempt > 1 }}

        steps:
            - name: 🔍 Determine deployment context
              id: context
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "deployment_type=manual" >> $GITHUB_OUTPUT
                    echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
                    echo "🔄 Manual deployment: ${{ github.ref_name }} branch"
                  elif [ "${{ github.event_name }}" == "pull_request" ]; then
                    echo "deployment_type=pr-deploy" >> $GITHUB_OUTPUT
                    echo "branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
                    echo "🔄 PR deployment: ${{ github.head_ref }} → ${{ github.base_ref }}"
                  elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
                    echo "deployment_type=develop" >> $GITHUB_OUTPUT
                    echo "branch=develop" >> $GITHUB_OUTPUT  
                    echo "🧪 Development deployment: develop branch"
                  else
                    echo "deployment_type=production" >> $GITHUB_OUTPUT
                    echo "branch=main" >> $GITHUB_OUTPUT
                    echo "🚀 Production deployment: main branch"
                  fi

            - name: 🚀 Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.PORT }}
                  script: |
                      echo "🎲 Starting Ilaris Foundry VTT deployment..."
                      echo "📍 System Version: ${{ needs.validate.outputs.system-version }}"
                      echo "🔄 Deployment Type: ${{ steps.context.outputs.deployment_type }}"
                      echo "🌿 Branch: ${{ steps.context.outputs.branch }}"

                      # Zum Repository-Verzeichnis wechseln
                      cd /home/leo/docker/foundryvtt-internal/foundry/git || {
                        echo "❌ Repository directory not found"
                        exit 1
                      }

                      # Branch bestimmen
                      TARGET_BRANCH="${{ steps.context.outputs.branch }}"
                      # Entsprechenden branch auschecken
                      echo "🔄 Fetching branch: $TARGET_BRANCH"
                      git fetch origin "$TARGET_BRANCH"
                      git checkout "$TARGET_BRANCH"
                      git reset --hard "origin/$TARGET_BRANCH"

                      # Prüfen ob Deploy-Script existiert
                      if [ -f "deploy.sh" ]; then
                        echo "📋 Using deploy.sh script"
                        chmod +x deploy.sh
                        ./deploy.sh
                      else
                        echo "📋 Deploy script not found, running manual deployment..."
                        
                        # Fallback: Manuelles Deployment
                        # Foundry stoppen (ohne sudo)
                        systemctl --user stop foundry 2>/dev/null || echo "⚠️ Could not stop foundry service (may not be running)"
                        
                        SYSTEM_PATH="/home/leo/docker/foundryvtt-internal/foundry/data/Data/systems/Ilaris"
                        mkdir -p "$(dirname "$SYSTEM_PATH")"
                        
                        # Dateien mit korrekten Berechtigungen entfernen
                        if [ -d "$SYSTEM_PATH" ]; then
                          chmod -R u+w "$SYSTEM_PATH" 2>/dev/null || true
                          rm -rf "$SYSTEM_PATH"
                        fi
                        
                        mkdir -p "$SYSTEM_PATH"
                        
                        rsync -av --exclude='.git' --exclude='.github' --exclude='README.md' --exclude='*.md' --exclude='.gitignore' . "$SYSTEM_PATH/"
                        
                        # Berechtigungen setzen
                        chmod -R 755 "$SYSTEM_PATH"
                        
                        # Foundry starten
                        systemctl --user start foundry 2>/dev/null || echo "⚠️ Could not start foundry service"
                        
                        echo "✅ Manual deployment completed"
                      fi

            - name: 🎉 Deployment Success
              if: success()
              run: |
                  echo "🎉 Ilaris System successfully deployed!"
                  echo "📋 Version: ${{ needs.validate.outputs.system-version }}"
                  echo "🔄 Type: ${{ steps.context.outputs.deployment_type }}"
                  echo "🌿 Branch: ${{ steps.context.outputs.branch }}"

                  if [ "${{ steps.context.outputs.deployment_type }}" == "pr-deploy" ]; then
                    echo "🧪 PR Branch Deployment complete - test your changes!"
                    echo "⚠️  This is a deployment from PR branch: ${{ steps.context.outputs.branch }}"
                  elif [ "${{ steps.context.outputs.deployment_type }}" == "manual" ]; then
                    echo "🔄 Manual Deployment complete"
                    echo "🔧 Manual deployment of ${{ steps.context.outputs.branch }} branch"
                  elif [ "${{ steps.context.outputs.deployment_type }}" == "develop" ]; then
                    echo "🧪 Development Deployment complete"
                    echo "🔄 Latest develop branch changes are now live"
                  else
                    echo "🚀 Production Deployment complete"
                    echo "🌟 Latest stable version is now live"
                  fi

                  echo "🌐 System should now be available in Foundry VTT"
                  echo "🔄 Players may need to refresh to see changes"

            - name: ❌ Deployment Failed
              if: failure()
              run: |
                  echo "❌ Deployment failed!"
                  echo "🔍 Common issues:"
                  echo "   - SSH connection problems (check HOST, USERNAME, SSH_PRIVATE_KEY, PORT secrets)"
                  echo "   - Deploy script errors"
                  echo "   - Foundry VTT service issues"
                  echo "   - File permission problems"
                  echo "   - Disk space issues"

    summary:
        name: 📊 Deployment Summary
        runs-on: ubuntu-latest
        needs: [validate, deploy]
        if: always()

        steps:
            - name: 📊 Summary Report
              run: |
                  echo "📊 Ilaris Foundry VTT Deployment Summary"
                  echo "======================================="
                  echo ""
                  echo "🔍 Validation: ${{ needs.validate.result }}"
                  echo "🚀 Deployment: ${{ needs.deploy.result }}"
                  echo ""

                  if [ "${{ needs.validate.outputs.system-version }}" != "" ]; then
                    echo "📋 System: ${{ needs.validate.outputs.system-title }} v${{ needs.validate.outputs.system-version }}"
                  fi

                  echo "🌟 Commit: ${{ github.sha }}"
                  echo "👤 Author: ${{ github.actor }}"
                  echo "⏰ Time: $(date -u)"

                  # Overall Status
                  if [ "${{ needs.deploy.result }}" == "success" ]; then
                    echo ""
                    echo "🎉 DEPLOYMENT SUCCESSFUL!"
                    echo "   Your Ilaris system is now live on the Foundry server"
                  elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
                    echo ""
                    echo "⏭️ DEPLOYMENT SKIPPED"
                    echo "   Check secrets configuration or branch restrictions"
                  elif [ "${{ needs.validate.result }}" == "failure" ]; then
                    echo ""
                    echo "❌ VALIDATION FAILED"
                    echo "   Fix system.json or template.json issues before deployment"
                  else
                    echo ""
                    echo "⚠️ DEPLOYMENT ISSUES"
                    echo "   Check the logs above for details"
                  fi
