name: ğŸ² Deploy Ilaris to Foundry VTT

on:
    push:
        branches: [main, master, develop]
    pull_request:
        branches: [develop]
        types: [opened, synchronize, reopened]
    workflow_dispatch:

env:
    SYSTEM_NAME: 'Ilaris'
    SYSTEM_PATH: '/home/leo/docker/foundryvtt-internal/foundry/data/Data/systems/Ilaris'

jobs:
    validate:
        name: ğŸ” Validate System Files
        runs-on: ubuntu-latest

        outputs:
            system-version: ${{ steps.system-info.outputs.version }}
            system-title: ${{ steps.system-info.outputs.title }}

        steps:
            - name: ğŸ“¥ Checkout Repository
              uses: actions/checkout@v4

            - name: ğŸ” Validate system.json
              id: system-info
              run: |
                  echo "ğŸ” Validating system.json..."

                  if [ ! -f "system.json" ]; then
                    echo "âŒ system.json not found"
                    exit 1
                  fi

                  # JSON Syntax prÃ¼fen
                  if ! jq empty system.json; then
                    echo "âŒ system.json is not valid JSON"
                    jq . system.json || true
                    exit 1
                  fi

                  # Required fields prÃ¼fen
                  REQUIRED_FIELDS=("id" "title" "version" "compatibility")
                  for field in "${REQUIRED_FIELDS[@]}"; do
                    if ! jq -e ".$field" system.json > /dev/null; then
                      echo "âŒ system.json missing required field: $field"
                      exit 1
                    fi
                  done

                  # System info extrahieren
                  SYSTEM_ID=$(jq -r '.id' system.json)
                  SYSTEM_TITLE=$(jq -r '.title' system.json)
                  SYSTEM_VERSION=$(jq -r '.version' system.json)
                  MIN_FOUNDRY=$(jq -r '.compatibility.minimum' system.json)
                  VERIFIED_FOUNDRY=$(jq -r '.compatibility.verified' system.json)

                  echo "âœ… system.json is valid"
                  echo "ğŸ“‹ System ID: $SYSTEM_ID"
                  echo "ğŸ“‹ System Title: $SYSTEM_TITLE"
                  echo "ğŸ“‹ System Version: $SYSTEM_VERSION"
                  echo "ğŸ“‹ Foundry Compatibility: $MIN_FOUNDRY - $VERIFIED_FOUNDRY"

                  # Outputs fÃ¼r andere Jobs setzen
                  echo "version=$SYSTEM_VERSION" >> $GITHUB_OUTPUT
                  echo "title=$SYSTEM_TITLE" >> $GITHUB_OUTPUT

                  # PrÃ¼fen ob System ID korrekt ist
                  if [ "$SYSTEM_ID" != "ilaris" ]; then
                    echo "âš ï¸ Warning: System ID is '$SYSTEM_ID', expected 'ilaris'"
                  fi

            - name: ğŸ” Validate template.json
              run: |
                  if [ -f "template.json" ]; then
                    echo "ğŸ” Validating template.json..."
                    if ! jq empty template.json; then
                      echo "âŒ template.json is not valid JSON"
                      jq . template.json || true
                      exit 1
                    fi
                    echo "âœ… template.json is valid"
                    
                    # Template structure prÃ¼fen
                    if jq -e '.Actor' template.json > /dev/null; then
                      ACTOR_TYPES=$(jq -r '.Actor.types[]?' template.json | tr '\n' ', ' | sed 's/,$//')
                      echo "ğŸ“‹ Actor Types: $ACTOR_TYPES"
                    fi
                    
                    if jq -e '.Item' template.json > /dev/null; then
                      ITEM_TYPES=$(jq -r '.Item.types[]?' template.json | tr '\n' ', ' | sed 's/,$//')
                      echo "ğŸ“‹ Item Types: $ITEM_TYPES"
                    fi
                  else
                    echo "â„¹ï¸ template.json not found (optional)"
                  fi

            - name: ğŸ” Analyze System Structure
              run: |
                  echo "ğŸ” Analyzing system structure..."

                  # JavaScript Dateien
                  JS_FILES=$(find . -name "*.js" -type f ! -path "./.git/*" ! -path "./node_modules/*" | wc -l)
                  echo "ğŸ“œ JavaScript files: $JS_FILES"
                  if [ $JS_FILES -gt 0 ]; then
                    echo "   Main files:"
                    find . -name "*.js" -type f ! -path "./.git/*" ! -path "./node_modules/*" | head -5 | sed 's/^/   - /'
                    if [ $JS_FILES -gt 5 ]; then
                      echo "   ... and $((JS_FILES - 5)) more"
                    fi
                  fi

                  # CSS Dateien
                  CSS_FILES=$(find . -name "*.css" -type f ! -path "./.git/*" | wc -l)
                  echo "ğŸ¨ CSS files: $CSS_FILES"
                  if [ $CSS_FILES -gt 0 ]; then
                    find . -name "*.css" -type f ! -path "./.git/*" | sed 's/^/   - /'
                  fi

                  # Handlebars Templates
                  HBS_FILES=$(find . -name "*.hbs" -type f ! -path "./.git/*" | wc -l)
                  echo "ğŸ“‹ Handlebars templates: $HBS_FILES"

                  # Language files
                  LANG_FILES=$(find . -name "*.json" -path "*/lang/*" -type f | wc -l)
                  echo "ğŸŒ Language files: $LANG_FILES"
                  if [ $LANG_FILES -gt 0 ]; then
                    find . -name "*.json" -path "*/lang/*" -type f | sed 's/^/   - /'
                  fi

                  # GrÃ¶ÃŸe berechnen
                  TOTAL_SIZE=$(du -sh . | cut -f1)
                  echo "ğŸ“ Total system size: $TOTAL_SIZE"

    deploy:
        name: ğŸš€ Deploy to Foundry Server
        runs-on: ubuntu-latest
        needs: validate
        # Deploy bei: Push auf main/master/develop ODER manual workflow_dispatch ODER manual rerun
        if: ${{ (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')) || github.event_name == 'workflow_dispatch' || github.run_attempt > 1 }}

        steps:
            - name: ğŸ” Determine deployment context
              id: context
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "deployment_type=manual" >> $GITHUB_OUTPUT
                    echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
                    echo "ğŸ”„ Manual deployment: ${{ github.ref_name }} branch"
                  elif [ "${{ github.event_name }}" == "pull_request" ]; then
                    echo "deployment_type=pr-deploy" >> $GITHUB_OUTPUT
                    echo "branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
                    echo "ğŸ”„ PR deployment: ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
                  elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
                    echo "deployment_type=develop" >> $GITHUB_OUTPUT
                    echo "branch=develop" >> $GITHUB_OUTPUT  
                    echo "ğŸ§ª Development deployment: develop branch"
                  else
                    echo "deployment_type=production" >> $GITHUB_OUTPUT
                    echo "branch=main" >> $GITHUB_OUTPUT
                    echo "ğŸš€ Production deployment: main branch"
                  fi

            - name: ğŸš€ Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.PORT }}
                  script: |
                      echo "ğŸ² Starting Ilaris Foundry VTT deployment..."
                      echo "ğŸ“ System Version: ${{ needs.validate.outputs.system-version }}"
                      echo "ğŸ”„ Deployment Type: ${{ steps.context.outputs.deployment_type }}"
                      echo "ğŸŒ¿ Branch: ${{ steps.context.outputs.branch }}"

                      # Zum Repository-Verzeichnis wechseln
                      cd /home/leo/docker/foundryvtt-internal/foundry/git || {
                        echo "âŒ Repository directory not found"
                        exit 1
                      }

                      # Branch bestimmen
                      TARGET_BRANCH="${{ steps.context.outputs.branch }}"
                      # Entsprechenden branch auschecken
                      echo "ğŸ”„ Fetching branch: $TARGET_BRANCH"
                      git fetch origin "$TARGET_BRANCH"
                      git checkout "$TARGET_BRANCH"
                      git reset --hard "origin/$TARGET_BRANCH"

                      # PrÃ¼fen ob Deploy-Script existiert
                      if [ -f "deploy.sh" ]; then
                        echo "ğŸ“‹ Using deploy.sh script"
                        chmod +x deploy.sh
                        ./deploy.sh
                      else
                        echo "ğŸ“‹ Deploy script not found, running manual deployment..."
                        
                        # Fallback: Manuelles Deployment
                        # Foundry stoppen (ohne sudo)
                        systemctl --user stop foundry 2>/dev/null || echo "âš ï¸ Could not stop foundry service (may not be running)"
                        
                        SYSTEM_PATH="/home/leo/docker/foundryvtt-internal/foundry/data/Data/systems/Ilaris"
                        mkdir -p "$(dirname "$SYSTEM_PATH")"
                        
                        # Dateien mit korrekten Berechtigungen entfernen
                        if [ -d "$SYSTEM_PATH" ]; then
                          chmod -R u+w "$SYSTEM_PATH" 2>/dev/null || true
                          rm -rf "$SYSTEM_PATH"
                        fi
                        
                        mkdir -p "$SYSTEM_PATH"
                        
                        rsync -av --exclude='.git' --exclude='.github' --exclude='README.md' --exclude='*.md' --exclude='.gitignore' . "$SYSTEM_PATH/"
                        
                        # Berechtigungen setzen
                        chmod -R 755 "$SYSTEM_PATH"
                        
                        # Foundry starten
                        systemctl --user start foundry 2>/dev/null || echo "âš ï¸ Could not start foundry service"
                        
                        echo "âœ… Manual deployment completed"
                      fi

            - name: ğŸ‰ Deployment Success
              if: success()
              run: |
                  echo "ğŸ‰ Ilaris System successfully deployed!"
                  echo "ğŸ“‹ Version: ${{ needs.validate.outputs.system-version }}"
                  echo "ğŸ”„ Type: ${{ steps.context.outputs.deployment_type }}"
                  echo "ğŸŒ¿ Branch: ${{ steps.context.outputs.branch }}"

                  if [ "${{ steps.context.outputs.deployment_type }}" == "pr-deploy" ]; then
                    echo "ğŸ§ª PR Branch Deployment complete - test your changes!"
                    echo "âš ï¸  This is a deployment from PR branch: ${{ steps.context.outputs.branch }}"
                  elif [ "${{ steps.context.outputs.deployment_type }}" == "manual" ]; then
                    echo "ğŸ”„ Manual Deployment complete"
                    echo "ğŸ”§ Manual deployment of ${{ steps.context.outputs.branch }} branch"
                  elif [ "${{ steps.context.outputs.deployment_type }}" == "develop" ]; then
                    echo "ğŸ§ª Development Deployment complete"
                    echo "ğŸ”„ Latest develop branch changes are now live"
                  else
                    echo "ğŸš€ Production Deployment complete"
                    echo "ğŸŒŸ Latest stable version is now live"
                  fi

                  echo "ğŸŒ System should now be available in Foundry VTT"
                  echo "ğŸ”„ Players may need to refresh to see changes"

            - name: âŒ Deployment Failed
              if: failure()
              run: |
                  echo "âŒ Deployment failed!"
                  echo "ğŸ” Common issues:"
                  echo "   - SSH connection problems (check HOST, USERNAME, SSH_PRIVATE_KEY, PORT secrets)"
                  echo "   - Deploy script errors"
                  echo "   - Foundry VTT service issues"
                  echo "   - File permission problems"
                  echo "   - Disk space issues"

    summary:
        name: ğŸ“Š Deployment Summary
        runs-on: ubuntu-latest
        needs: [validate, deploy]
        if: always()

        steps:
            - name: ğŸ“Š Summary Report
              run: |
                  echo "ğŸ“Š Ilaris Foundry VTT Deployment Summary"
                  echo "======================================="
                  echo ""
                  echo "ğŸ” Validation: ${{ needs.validate.result }}"
                  echo "ğŸš€ Deployment: ${{ needs.deploy.result }}"
                  echo ""

                  if [ "${{ needs.validate.outputs.system-version }}" != "" ]; then
                    echo "ğŸ“‹ System: ${{ needs.validate.outputs.system-title }} v${{ needs.validate.outputs.system-version }}"
                  fi

                  echo "ğŸŒŸ Commit: ${{ github.sha }}"
                  echo "ğŸ‘¤ Author: ${{ github.actor }}"
                  echo "â° Time: $(date -u)"

                  # Overall Status
                  if [ "${{ needs.deploy.result }}" == "success" ]; then
                    echo ""
                    echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
                    echo "   Your Ilaris system is now live on the Foundry server"
                  elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
                    echo ""
                    echo "â­ï¸ DEPLOYMENT SKIPPED"
                    echo "   Check secrets configuration or branch restrictions"
                  elif [ "${{ needs.validate.result }}" == "failure" ]; then
                    echo ""
                    echo "âŒ VALIDATION FAILED"
                    echo "   Fix system.json or template.json issues before deployment"
                  else
                    echo ""
                    echo "âš ï¸ DEPLOYMENT ISSUES"
                    echo "   Check the logs above for details"
                  fi
